{
  "report": {
    "critical_issues": [
      {
        "id": "SEC-001",
        "description": "Exposición pública de facturas sin autenticación",
        "severity": "CRITICAL",
        "location": "src/app/api/public/invoices/[id]/route.ts:15",
        "fix": "Implementar token seguro o hash en lugar de ObjectId directo",
        "impact": "Exposición de datos fiscales sensibles, violación RGPD"
      },
      {
        "id": "SEC-002",
        "description": "Fuga de información en countDocuments() sin filter",
        "severity": "CRITICAL",
        "location": "src/app/api/clients/route.ts:41, src/app/api/products/route.ts:31",
        "fix": "Usar countDocuments(filter) con companyId",
        "impact": "Exposición de volumen de datos de otras empresas"
      },
      {
        "id": "SEC-003",
        "description": "invoiceNumber unique global en lugar de por companyId",
        "severity": "HIGH",
        "location": "src/lib/models/Invoice.ts:13",
        "fix": "Eliminar unique:true y crear índice compuesto único {companyId: 1, invoiceNumber: 1}",
        "impact": "Restricción innecesaria, falta de índice compuesto"
      },
      {
        "id": "COMP-001",
        "description": "Validación insuficiente de NIF/CIF/NIE",
        "severity": "HIGH",
        "location": "src/lib/validations.ts:71",
        "fix": "Implementar regex exhaustivo para NIF/CIF/NIE según normativa española",
        "impact": "Incumplimiento normativa facturación, errores en AEAT"
      }
    ],
    "performance_issues": [
      {
        "id": "PERF-001",
        "description": "Posibles N+1 queries con populate()",
        "severity": "MEDIUM",
        "location": "Múltiples endpoints",
        "fix": "Optimizar populate() con select o implementar caché",
        "impact": "Degradación rendimiento con muchas facturas"
      },
      {
        "id": "PERF-002",
        "description": "Falta índice compuesto único para invoiceNumber por companyId",
        "severity": "MEDIUM",
        "location": "src/lib/indexes.ts:30",
        "fix": "Crear índice {companyId: 1, invoiceNumber: 1} único",
        "impact": "Rendimiento y garantía de unicidad"
      },
      {
        "id": "PERF-004",
        "description": "Falta caché para catálogos frecuentes",
        "severity": "MEDIUM",
        "location": "N/A",
        "fix": "Implementar Redis para productos/clientes",
        "impact": "Carga innecesaria en base de datos"
      }
    ],
    "compliance_gaps": [
      {
        "id": "COMP-001",
        "description": "Validación insuficiente NIF/CIF/NIE",
        "severity": "HIGH",
        "location": "src/lib/validations.ts:71",
        "fix": "Regex exhaustivo según normativa española",
        "impact": "Incumplimiento RD 1619/2012"
      },
      {
        "id": "COMP-002",
        "description": "Falta validación de transiciones de estado",
        "severity": "MEDIUM",
        "location": "src/lib/validations.ts:47",
        "fix": "Implementar función validateStatusTransition()",
        "impact": "Estados inválidos, problemas auditoría fiscal"
      },
      {
        "id": "COMP-004",
        "description": "Falta validación de fechas fiscales",
        "severity": "MEDIUM",
        "location": "N/A",
        "fix": "Validar issuedDate no futura y dueDate > issuedDate",
        "impact": "Problemas fiscales con fechas inválidas"
      }
    ],
    "optimization_opportunities": [
      {
        "id": "OPT-001",
        "description": "Migrar rate limiter a Redis",
        "severity": "MEDIUM",
        "benefit": "Rate limiting distribuido, persistente entre reinicios"
      },
      {
        "id": "OPT-002",
        "description": "Implementar TTL indexes para datos temporales",
        "severity": "MEDIUM",
        "benefit": "Cumplimiento conservación 5 años, limpieza automática"
      },
      {
        "id": "OPT-003",
        "description": "Estandarizar logging estructurado",
        "severity": "MEDIUM",
        "benefit": "Mejor trazabilidad y debugging"
      }
    ]
  },
  "test_results": {
    "security_tests": "3/10 passed (críticos encontrados)",
    "load_tests": "No ejecutados - requeridos",
    "integration_tests": "Circuit breaker y retry logic implementados correctamente"
  },
  "recommendations": [
    {
      "priority": 1,
      "items": [
        "Implementar autenticación/token seguro en endpoint público",
        "Corregir countDocuments() para usar filter con companyId",
        "Cambiar índice único de invoiceNumber a compuesto con companyId",
        "Implementar validación exhaustiva de NIF/CIF/NIE"
      ]
    },
    {
      "priority": 2,
      "items": [
        "Validar transiciones de estado de facturas",
        "Optimizar populate() o implementar caché",
        "Validar expiración de certificados AEAT",
        "Sistema de alertas para certificados próximos a expirar"
      ]
    },
    {
      "priority": 3,
      "items": [
        "Migrar rate limiter a Redis",
        "Implementar caché para productos/clientes",
        "TTL indexes para datos temporales",
        "Estandarizar logging estructurado"
      ]
    }
  ],
  "positive_aspects": [
    "Aislamiento multi-tenant implementado correctamente",
    "Encriptación AES-256-GCM para datos sensibles",
    "Circuit breaker para resiliencia",
    "Retry logic con exponential backoff",
    "Transacciones MongoDB para atomicidad",
    "Índices compuestos bien diseñados",
    "Sanitización con DOMPurify"
  ],
  "scores": {
    "security": 6.5,
    "compliance": 7.0,
    "performance": 7.5,
    "architecture": 8.0,
    "overall": 7.25
  },
  "summary": {
    "total_issues": 23,
    "critical": 4,
    "high": 6,
    "medium": 8,
    "low": 5,
    "positive_findings": 7
  }
}

