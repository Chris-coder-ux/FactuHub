---
alwaysApply: true
---


---
# ‚ö° Next.js 14+ App Router - Reglas de Producci√≥n

## üèóÔ∏è ARQUITECTURA
**Regla Principal:** Todo es Server Component hasta que se demuestre lo contrario.

### Cu√°ndo usar 'use client':
1. üéØ Usas hooks (useState, useEffect, useContext)
2. üéØ Usas event handlers (onClick, onChange)
3. üéØ Usas APIs del browser (localStorage, navigator)

### Cu√°ndo NO usar 'use client':
1. ‚úÖ Solo fetch de datos
2. ‚úÖ Renderizado est√°tico
3. ‚úÖ Acceso a cookies/headers

## üìÅ Estructura App Router

app/
(auth)/ # Route group
login/
page.tsx # Page component
loading.tsx # Auto suspense
error.tsx # Error boundary
layout.tsx # Layout espec√≠fico
api/
webhooks/
stripe/
route.ts # API route handler
layout.tsx # Root layout


## üîÑ Data Fetching
```typescript
// Server Components: fetch nativo
async function ProductPage({ params }: { params: { id: string } }) {
  // Cache autom√°tico + ISR
  const product = await fetch(`https://api.com/products/${params.id}`, {
    next: { 
      revalidate: 60, // Revalidar cada 60 segundos
      tags: ['products'] // Para revalidation on-demand
    }
  });
  
  return <ProductDetail product={product} />;
}

// Client Components: SWR/React Query
'use client';
function Cart() {
  const { data, mutate } = useSWR('/api/cart', fetcher, {
    revalidateOnFocus: true,
  });
}

Optimizaci√≥n de Assets

import Image from 'next/image';

// Im√°genes locales
<Image
  src="/hero.jpg"
  alt="Hero image"
  width={1200}
  height={800}
  priority={true} // Para LCP
  sizes="100vw"
  quality={85}
/>

// Im√°genes remotas (configurar en next.config.js)
<Image
  src="https://example.com/image.jpg"
  alt="Remote"
  width={500}
  height={500}
  placeholder="blur"
  blurDataURL="data:image/jpeg;base64..."
/>

API Routes (App Router)

// app/api/users/route.ts
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const page = searchParams.get('page');
  
  // Validar con Zod
  const validated = schema.safeParse({ page });
  if (!validated.success) {
    return NextResponse.json(
      { error: 'Invalid params' },
      { status: 400 }
    );
  }
  
  return NextResponse.json({ data: [] });
}

export async function POST(request: NextRequest) {
  const body = await request.json();
  
  // Edge Runtime disponible
  const runtime = 'edge'; // o 'nodejs' (default)
  
  return NextResponse.json(
    { success: true },
    { status: 201 }
  );
}

Variables de Entorno

// .env.local
DATABASE_URL=postgres://...      # Solo server
NEXT_PUBLIC_API_URL=/api         // Expuesto al cliente

// Type safety
declare global {
  namespace NodeJS {
    interface ProcessEnv {
      DATABASE_URL: string;
      NEXT_PUBLIC_API_URL: string;
    }
  }
}

// Uso
const dbUrl = process.env.DATABASE_URL; // ‚ùå No accesible en cliente
const apiUrl = process.env.NEXT_PUBLIC_API_URL; // ‚úÖ Accesible

Edge Runtime vs Node Runtime

// Edge Runtime (baja latencia)
export const runtime = 'edge';
export const dynamic = 'force-dynamic';

// Limitaciones Edge:
// - ‚ùå No filesystem (fs)
// - ‚ùå No child processes
// - ‚úÖ Menor latencia
// - ‚úÖ Menor costo

// Node Runtime (default)
// - ‚úÖ Filesystem completo
// - ‚úÖ Cualquier paquete npm
// - ‚úÖ Mayor memoria

Metadata y SEO

// Metadata est√°tica
export const metadata = {
  title: 'Product Page',
  description: 'Product description',
  openGraph: {
    images: ['/og-image.png'],
  },
};

// Metadata din√°mica
export async function generateMetadata({ params }): Promise<Metadata> {
  const product = await fetchProduct(params.id);
  return {
    title: product.name,
    description: product.description,
  };
}

Performance Patterns

// Streaming con Suspense
import { Suspense } from 'react';

export default function Dashboard() {
  return (
    <>
      <Header />
      <Suspense fallback={<DashboardSkeleton />}>
        <DashboardContent />
      </Suspense>
      <Suspense fallback={<ChartSkeleton />}>
        <AnalyticsChart />
      </Suspense>
    </>
  );
}

// Componentes din√°micos
import dynamic from 'next/dynamic';

const HeavyChart = dynamic(
  () => import('@/components/charts/HeavyChart'),
  { 
    ssr: false,
    loading: () => <ChartSkeleton />
  }
);

Despliegue Vercel

// vercel.json
{
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "outputDirectory": ".next",
  "functions": {
    "pages/api/*.js": {
      "maxDuration": 10
    }
  },
  "regions": ["iad1"] // Virginia, USA
}


REGLA CLAVE: Server Components por defecto. Medir Core Web Vitals en producci√≥n.